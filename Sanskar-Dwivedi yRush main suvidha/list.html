<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>yRush ¬∑ Stationery</title>
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
<header>
  <div class="container row">
    <div class="brand">yRush ¬∑ Stationery</div>
    <div class="grow"></div>
    <div id="userBox" class="badge"></div>
    <button id="signOut" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<main class="container">
  <div class="row" style="margin:12px 0 8px">
    <input id="search" class="input" placeholder="Search items‚Ä¶" aria-label="Search products">
    <select id="filter" class="select" aria-label="Filter by category">
      <option value="">All categories</option>
      <option>Drawing</option><option>Practical</option><option>Geometry</option>
      <option>Stationery</option><option>Storage</option><option>Digital</option>
      <option>Xerox</option>
    </select>
    <select id="sort" class="select" aria-label="Sort products">
      <option value="reco">Sort: Recommended</option>
      <option value="price_asc">Price: Low to High</option>
      <option value="price_desc">Price: High to Low</option>
      <option value="name_asc">Name: A‚ÄìZ</option>
    </select>
    <!-- Checkout button removed: use 'Proceed' in the sidebar -->
  </div>

  <div id="productGrid" class="grid product-grid" role="list" aria-live="polite"></div>
</main>

<aside class="sidebar" aria-label="Cart">
  <h3>Cart</h3>
  <div id="cartList"></div>
  <div class="total"><span>Subtotal</span><span id="subtotal">‚Çπ0</span></div>
  <hr>
  <div class="total"><span>Total</span><span id="total">‚Çπ0</span></div>
  <div style="margin-top:10px;display:flex;gap:8px">
    <a class="btn btn-primary" style="flex:1;text-align:center" href="checkOut.html">Proceed</a>
    <button id="clearCart" class="btn btn-ghost">Clear</button>
  </div>
</aside>

<footer class="container">¬© yRush campus mini‚Äëstore</footer>

<script src="assets/catalog.js"></script>
<script src="assets/app.js"></script>
<script>
(function(){
  const u = yRush.requireAuth();
  document.getElementById('userBox').textContent = u.name ? (u.name + ' ¬∑ ' + (u.type||'')) : u.email;
  document.getElementById('signOut').onclick = ()=>{ yRush.signOut(); location.href='login.html'; };

  const els = {
    grid: document.getElementById('productGrid'),
    search: document.getElementById('search'),
    filter: document.getElementById('filter'),
    sort: document.getElementById('sort'),
    cartList: document.getElementById('cartList'),
    subtotal: document.getElementById('subtotal'),
    total: document.getElementById('total'),
    clearCart: document.getElementById('clearCart'),
  };

  function getViewItems(){
    const q = (els.search.value||'').toLowerCase();
    const f = els.filter.value;
    let items = window.CATALOG.filter(p =>
      (!f || p.category===f) &&
      (p.name.toLowerCase().includes(q) || (p.details||'').toLowerCase().includes(q))
    );
    const s = els.sort.value;
    if(s==='price_asc') items.sort((a,b)=>a.price-b.price);
    else if(s==='price_desc') items.sort((a,b)=>b.price-a.price);
    else if(s==='name_asc') items.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    return items;
  }

  function productCard(p){
    return `
      <article class="card" role="listitem">
        <div class="thumb">
          <img loading="lazy" width="640" height="480" src="${p.image||''}" alt="${p.name}">
        </div>
        <div class="meta">
          <div class="row-split">
            <div>${p.name}</div>
            <div class="price">${yRush.money(p.price)}</div>
          </div>
          <div class="badge">${p.category||''}</div>
          <div class="qty">
            <label for="qty-${p.id}" class="badge" style="min-width:1px">Qty</label>
            <input id="qty-${p.id}" class="input" type="number" min="1" value="1" aria-label="Quantity for ${p.name}">
            <button class="btn btn-primary add" data-id="${p.id}">Add to cart</button>
          </div>
        </div>
      </article>`;
  }

  function renderProducts(){
    els.grid.innerHTML = getViewItems().map(productCard).join('');
  }

  function renderCart(){
    const c = yRush.getCart();
    const lines = yRush.cartLinesArray(c);
    if(!lines.length){
      els.cartList.innerHTML = '<div class="empty">Your cart is empty. <a href="#top">Browse items</a></div>';
    }else{
      els.cartList.innerHTML = lines.map(l=>{
        const p = window.CATALOG.find(x=>x.id===l.id) || {};
        return `<div class="cart-row" data-id="${l.id}">
          <div class="mini">${p.image?`<img src="${p.image}" alt="${l.name}" width="48" height="48">`:'üõçÔ∏è'}</div>
          <div>
            <div>${l.name}</div>
            <div class="badge">${yRush.money(l.price)}</div>
          </div>
          <div class="qty">
            <input class="input qty-input" type="number" min="0" value="${l.qty}" aria-label="Quantity for ${l.name}">
            <button class="btn btn-ghost rm">‚úï</button>
          </div>
        </div>`;
      }).join('');
    }
    const t = yRush.cartTotals();
    els.subtotal.textContent = yRush.money(t.subtotal);
    els.total.textContent = yRush.money(t.total);
  }

  // Events
  els.grid.addEventListener('click', (e)=>{
    const btn = e.target.closest('.add');
    if(!btn) return;
    const id = btn.dataset.id;
    const qtyEl = document.getElementById('qty-'+id);
    const qty = Math.max(1, parseInt(qtyEl.value||'1',10));
    yRush.addToCart(id, qty);
    yRush.toast('Added to cart');
    renderCart();
  });

  els.cartList.addEventListener('input', (e)=>{
    const row = e.target.closest('.cart-row'); if(!row) return;
    const id = row.dataset.id;
    const qty = Math.max(0, parseInt(e.target.value||'0',10));
    yRush.setQty(id, qty);
    renderCart();
  });
  els.cartList.addEventListener('click', (e)=>{
    const btn = e.target.closest('.rm'); if(!btn) return;
    const row = e.target.closest('.cart-row'); const id = row.dataset.id;
    yRush.setQty(id, 0); renderCart();
  });

  ['input','change'].forEach(ev=>{
    els.search.addEventListener(ev, renderProducts);
    els.filter.addEventListener(ev, renderProducts);
    els.sort.addEventListener(ev, renderProducts);
  });
  els.clearCart.onclick = ()=>{ yRush.clearCart(); renderCart(); };

  // Init
  renderProducts();
  renderCart();
})();
</script>
</body>
</html>