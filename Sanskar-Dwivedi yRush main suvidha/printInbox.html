<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>yRush ¬∑ Print Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0d10;--panel:#12151a;--text:#e5e7eb;--muted:#9aa4b5;--border:#202734;--accent:#60e7d7;--good:#10B981}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1000px;margin:32px auto;padding:20px;background:var(--panel);border:1px solid var(--border);border-radius:16px}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;text-decoration:none;color:var(--text)}
    .btn.primary{background:var(--accent);color:#0b0d10;border-color:#1f3b3b;font-weight:700}
    .btn.good{background:var(--good);color:#052b23;border-color:#065f46;font-weight:700}
    .topbar{display:flex;gap:10px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{color:var(--muted)}
    .files a{display:inline-block;margin:2px 6px 2px 0}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="list.html">üè† Home</a>
      <a class="btn" href="xerox.html">‚¨ÜÔ∏è Upload (Xerox)</a>
      <button id="clearAll" class="btn">üóëÔ∏è Clear All</button>
    </div>

    <h1>Print Inbox</h1>
    <p class="muted">New jobs appear here automatically. Click a file to download/print. Mark a job as <b>Printed</b> when done.</p>

    <table>
      <thead>
        <tr>
          <th>ID / Time</th>
          <th>Customer</th>
          <th>Options</th>
          <th>Files</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <script>
    const KEY = 'yrush_print_jobs';
    const DONE_KEY = 'yrush_print_jobs_done';
    const rows = document.getElementById('rows');

    const load = k => { try{return JSON.parse(localStorage.getItem(k))||[];}catch(e){return [];} };
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    function fmt(dt){ try{ return new Date(dt).toLocaleString('en-IN'); } catch{ return dt; } }

    function render(){
      const jobs = load(KEY).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      rows.innerHTML = jobs.map(j => {
        const fhtml = (j.files||[]).map((f,idx)=>{
          const name = f.name || `file-${idx+1}`;
          // download link from data URL
          return `<a class="btn" download="${name}" href="${f.dataUrl}">‚¨áÔ∏è ${name}</a>`;
        }).join(' ');

        const opts = j.options||{};
        const optStr = `
          Copies: <b>${opts.copies||1}</b><br/>
          Color: <b>${opts.color||'BW'}</b>, Sides: <b>${opts.sides||'single'}</b><br/>
          Paper: <b>${opts.paper||'A4'}</b><br/>
          Pages: <b>${opts.pages||'-'}</b><br/>
          Notes: <b>${opts.notes||'-'}</b>
        `;

        return `<tr>
          <td><b>${j.id}</b><br/><span class="muted">${fmt(j.createdAt)}</span></td>
          <td><b>${j.customer?.name||'-'}</b><br/><span class="muted">${j.customer?.phone||''}</span></td>
          <td>${optStr}</td>
          <td class="files">${fhtml || '<span class="muted">No files</span>'}</td>
          <td><span class="tag">${j.status||'Queued'}</span></td>
          <td>
            <button class="btn good" onclick="markPrinted('${j.id}')">Printed</button>
            <button class="btn" onclick="removeJob('${j.id}')">Remove</button>
          </td>
        </tr>`;
      }).join('') || `<tr><td colspan="6" class="muted">No print jobs yet.</td></tr>`;
    }

    function markPrinted(id){
      const jobs = load(KEY);
      const idx = jobs.findIndex(j=>j.id===id);
      if(idx>=0){
        const [job] = jobs.splice(idx,1);
        job.status = 'Printed';
        const done = load(DONE_KEY);
        done.push(job);
        save(DONE_KEY, done);
        save(KEY, jobs);
        render();
      }
    }

    function removeJob(id){
      const jobs = load(KEY).filter(j=>j.id!==id);
      save(KEY, jobs);
      render();
    }

    document.getElementById('clearAll').onclick = ()=>{
      if(confirm('Clear ALL pending print jobs?')){ save(KEY, []); render(); }
    };

    // live updates from uploader tab
    try{
      if(typeof BroadcastChannel!=='undefined'){
        const ch = new BroadcastChannel('yRush_print');
        ch.onmessage = (msg)=>{ if(msg?.data?.type==='PRINT_JOB_NEW'){ render(); } };
      }
    }catch(e){}

    render();
  </script>
</body>
</html>
