<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>yRush · Checkout</title>
  <link rel="stylesheet" href="assets/app.css">
  <style>
    .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:800px){ .two{grid-template-columns:1fr} }
    .box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center}
    .mt-16{margin-top:16px}
    #whatsappBtn{display:block;width:100%}
  </style>
</head>
<body>
<header>
  <div class="container row">
    <div class="brand">yRush · Checkout</div>
    <div class="grow"></div>
    <a class="btn btn-ghost" href="list.html">Back to store</a>
  </div>
</header>

<main class="container">
  <div class="two" style="margin-top:14px">
    <section class="box">
      <h3>Contact & Pickup</h3>

      <form id="orderForm">
        <div class="row">
          <div style="flex:1">
            <label>Name</label>
            <input id="name" class="input" autocomplete="name" required>
          </div>
          <div style="flex:1">
            <label>Class / Dept</label>
            <input id="klass" class="input" placeholder="e.g., CSE-B" required>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Phone</label>
            <input id="phone" class="input" inputmode="numeric" pattern="[0-9]{10}" maxlength="10" autocomplete="tel-national" required>
          </div>
          <div style="flex:1">
            <label>Email</label>
            <input id="email" class="input" type="email" autocomplete="email" required>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Payment</label>
            <select id="pay" class="select">
              <option>UPI at pickup</option>
              <option>UPI (online)</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Notes</label>
            <input id="notes" class="input" placeholder="Any special request?">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" type="submit" style="flex:1">Place order</button>
          <button class="btn btn-ghost" id="clear" type="button">Clear cart</button>
        </div>

        <!-- WhatsApp button (shown after order is placed) -->
        <div id="whatsappSection" class="mt-16" style="display:none;">
          <a class="btn btn-primary" id="whatsappBtn" target="_blank" style="background:#25D366;color:#fff;">
            📱 Notify Seller via WhatsApp
          </a>
        </div>
      </form>

      <div id="orderResult" style="margin-top:12px"></div>
      <div class="hint" id="tokenWarning" style="margin-top:6px;color:var(--muted)">
        Do not share your order token with anyone (except shopkeeper).
      </div>
    </section>

    <aside class="box">
      <h3>Order summary</h3>
      <div id="summary"></div>
      <hr>
      <div class="total"><span>Subtotal</span><span id="subtotal">₹0</span></div>
      <hr>
      <div class="total"><span>Total</span><span id="total">₹0</span></div>
    </aside>
  </div>

  <section class="box" style="margin-top:16px">
    <h3>Past orders</h3>
    <div id="history" class="table-wrap">
      <table class="table" id="ordersTable">
        <thead><tr><th>Token</th><th>Date</th><th>Name</th><th>Items</th><th>Total</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script src="assets/catalog.js"></script>
<script src="assets/app.js"></script>
<script>
(function(){
  const u = yRush.requireAuth();

  function loadSummary(){
    const t = yRush.cartTotals();
    const lines = t.lines;
    if(!lines.length){ location.href='list.html'; return; }
    document.getElementById('summary').innerHTML = lines.map(l=>{
      return `<div class="row" style="justify-content:space-between"><div>${l.name} × ${l.qty}</div><div>${yRush.money(l.price*l.qty)}</div></div>`;
    }).join('');
    document.getElementById('subtotal').textContent = yRush.money(t.subtotal);
    document.getElementById('total').textContent = yRush.money(t.total);
  }

  function renderHistory(){
    const tbody = document.querySelector('#ordersTable tbody');
    try{
      const raw = yRush.getOrders();
      const orders = Array.isArray(raw) ? raw.slice().reverse() : [];
      if(!orders.length){
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted)">No orders yet</td></tr>`;
        return;
      }
      tbody.innerHTML = orders.map(o=>{
        const date = o.createdAt ? new Date(o.createdAt).toLocaleString('en-IN') : '—';
        const items = Array.isArray(o.lines) ? o.lines.map(l=>\`${l.name}×${l.qty}\`).join(', ') : '';
        return `<tr><td>${o.token}</td><td>${date}</td><td>${o.name || '—'}</td><td>${items}</td><td>${yRush.money(o.total||0)}</td><td>${o.status||'—'}</td></tr>`;
      }).join('');
    }catch(err){
      console.error('renderHistory error', err);
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted)">Unable to load orders</td></tr>`;
    }
  }

  // ---- Return-from-payment handler (must run early) ----
  const paidToken = localStorage.getItem('paymentSuccess');
  if(paidToken){
    const pendingJSON = localStorage.getItem('pendingOrder');
    try{
      const pending = pendingJSON ? JSON.parse(pendingJSON) : null;
      if(pending && pending.token === paidToken){
        pending.status = 'Paid';
        const orders = yRush.getOrders();
        const list = Array.isArray(orders) ? orders : [];
        list.push(pending);
        yRush.saveOrders(list);
        localStorage.removeItem('pendingOrder');
        localStorage.removeItem('paymentSuccess');
        yRush.clearCart();

        // Success UI
        document.getElementById('orderResult').innerHTML =
          `<div class="success">✅ Payment successful! Order placed.<br>Token: <strong>${paidToken}</strong></div>`;

        // Show WhatsApp button for the paid order
        showWhatsappForOrder(pending);
        renderHistory();
      } else {
        // cleanup stray flag
        localStorage.removeItem('paymentSuccess');
      }
    }catch(e){
      console.warn('Pending parse error', e);
      localStorage.removeItem('paymentSuccess');
    }
  }
  // ------------------------------------------------------

  document.getElementById('clear').onclick = ()=>{ yRush.clearCart(); loadSummary(); };

  // Helper to show WhatsApp CTA
  function showWhatsappForOrder(order){
    const whatsappSection = document.getElementById('whatsappSection');
    const whatsappBtn = document.getElementById('whatsappBtn');

    const itemsList = (order.lines||[]).map(item => `${item.name} (Qty: ${item.qty})`).join('%0A- ');
    const message =
      `📦 New Order Alert!%0A%0A` +
      `🆔 Token: ${order.token}%0A` +
      `👤 Customer: ${order.name}%0A` +
      `📞 Phone: ${order.phone}%0A` +
      `🎓 Class: ${order.klass}%0A` +
      `💰 Total: ${yRush.money(order.total||0)}%0A` +
      `💳 Payment: ${order.status}%0A%0A` +
      `📋 Items:%0A- ${itemsList}%0A%0A` +
      `📝 Notes: ${order.notes || 'None'}`;

    // Replace the phone with your seller's number (with country code, no +)
    whatsappBtn.href = `https://wa.me/917820873853?text=${message}`;
    whatsappSection.style.display = 'block';
  }

  document.getElementById('orderForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const submitBtn = document.querySelector('#orderForm button[type="submit"]');
    const origText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Placing…';

    const name  = document.getElementById('name').value.trim();
    const klass = document.getElementById('klass').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const pay   = document.getElementById('pay').value;
    const notes = document.getElementById('notes').value.trim();

    if(!/^\d{10}$/.test(phone)){
      yRush.toast('Enter a 10-digit phone number');
      submitBtn.disabled = false; submitBtn.textContent = origText; return;
    }

    const totals = yRush.cartTotals();
    if(!Array.isArray(totals.lines) || !totals.lines.length){
      yRush.toast('Your cart is empty');
      submitBtn.disabled = false; submitBtn.textContent = origText; return;
    }

    // If UPI Online -> go to payment page first
    if (/upi/i.test(pay) && pay.toLowerCase().includes('online')) {
      const tokenTemp = yRush.token6();
      const pendingOrder = {
        token: tokenTemp, user: u.email, name, klass, phone, email, pay, notes,
        lines: totals.lines, subtotal: totals.subtotal, total: totals.total,
        status: 'Pending Payment', createdAt: new Date().toISOString()
      };
      localStorage.setItem('pendingOrder', JSON.stringify(pendingOrder));

      const returnUrl = encodeURIComponent(location.href);
      const paymentUrl = `payment.html?token=${tokenTemp}&return=${returnUrl}`;
      window.location.href = paymentUrl;
      return; // stop here; we’ll finalize after returning
    }

    // Otherwise: immediate (UPI at pickup) — save as Unpaid
    const token = yRush.token6();
    const order = {
      token, user: u.email, name, klass, phone, email, pay, notes,
      lines: totals.lines, subtotal: totals.subtotal, total: totals.total,
      status: 'Unpaid', createdAt: new Date().toISOString()
    };
    const orders = yRush.getOrders();
    const list = Array.isArray(orders) ? orders : [];
    list.push(order);
    yRush.saveOrders(list);

    // Clear cart + update UI without redirect
    yRush.clearCart();
    document.getElementById('summary').innerHTML = '';
    document.getElementById('subtotal').textContent = yRush.money(0);
    document.getElementById('total').textContent = yRush.money(0);

    document.getElementById('orderResult').innerHTML =
      `<div class="success">Order placed! Token: <strong>${token}</strong>. Show this token at pickup.</div>`;

    showWhatsappForOrder(order);

    submitBtn.disabled = false;
    submitBtn.textContent = origText;
    document.getElementById('orderResult').scrollIntoView({behavior:'smooth', block:'center'});
    renderHistory();
  });

  loadSummary();
  renderHistory();
})();
</script>
</body>
</html>
