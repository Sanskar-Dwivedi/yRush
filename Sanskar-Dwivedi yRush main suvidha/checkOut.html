<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>yRush ¬∑ Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0d10;--panel:#12151a;--text:#e5e7eb;--muted:#9aa4b5;--accent:#60e7d7;--border:#202734;--success:#10B981;--danger:#ef4444}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:720px;margin:32px auto;padding:20px;background:var(--panel);border:1px solid var(--border);border-radius:16px}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e1319;color:var(--text)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center;margin:6px 0}
    .money{font-weight:700}
    .hr{height:1px;background:var(--border);margin:16px 0}
    .btn{display:inline-block;padding:12px 16px;border-radius:10px;border:1px solid var(--border);cursor:pointer;text-decoration:none;color:var(--text)}
    .btn.primary{background:var(--accent);color:#0b0d10;border-color:#1f3b3b;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.disabled{opacity:.55;pointer-events:none}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .callout{padding:12px;border-radius:10px;border:1px solid var(--border);background:#0e1319;margin-top:12px}
    .success{background:rgba(16,185,129,.12);border-color:#065f46}
    .danger{background:rgba(239,68,68,.12);border-color:#7f1d1d}
    .topbar{display:flex;gap:10px;margin-bottom:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn ghost" href="list.html">‚Üê Back</a>
      <a class="btn ghost" href="history.html">üïò History</a>
    </div>

    <h1>Checkout</h1>
    <p class="muted">Demo flow with UPI-QR page. Token is generated and saved to Admin/History after you click ‚ÄúPayment Done‚Äù.</p>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Your name</label>
        <input id="custName" placeholder="e.g. Sanskar" />
      </div>
      <div>
        <label>Phone</label>
        <input id="custPhone" placeholder="10-digit phone" inputmode="numeric" />
      </div>
      <div>
        <label>Email (optional)</label>
        <input id="custEmail" placeholder="you@example.com" />
      </div>
      <div>
        <label>Class/Section (optional)</label>
        <input id="custClass" placeholder="e.g. CSE-A" />
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Notes (optional)</label>
      <textarea id="custNotes" placeholder="Any special instructions"></textarea>
    </div>

    <div class="hr"></div>

    <!-- Totals -->
    <div class="row">
      <div class="muted">Items total</div>
      <div style="margin-left:auto"><span id="subtotal">‚Çπ0.00</span></div>
    </div>
    <div class="row" style="font-size:18px">
      <div class="money">Grand Total</div>
      <div class="money" style="margin-left:auto"><span id="grand">‚Çπ0.00</span></div>
    </div>

    <div id="orderResult" class="callout" style="display:none"></div>

    <div class="bar" id="payBar">
      <button id="btnUpi" class="btn primary">üí∏ Pay with UPI (online)</button>
      <button id="btnReset" class="btn ghost">Reset demo</button>
      <a class="btn ghost" href="history.html">Open Order History</a>
    </div>
  </div>

<!-- Add these so yRush is available to the inline script below -->
<script src="assets/catalog.js"></script>
<script src="assets/app.js"></script>

<script>
  // ---------- utils ----------
  const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load = (k)=>{try{return JSON.parse(localStorage.getItem(k));}catch(e){return null;}};
  const money=n=>'‚Çπ'+(Number(n)||0).toFixed(2);

  // safer token
  const uid=(l=6)=>Math.random().toString().slice(2,2+l);
  const newToken=()=> {
    if(window.crypto && crypto.randomUUID) return 'T'+crypto.randomUUID().replace(/-/g,'').slice(0,12);
    return 'T'+new Date().toISOString().replace(/[-:TZ.]/g,'').slice(2,8)+'-'+uid(8);
  };

  // ---------- yRush readiness ----------
  function ensureYRushReady(timeout = 2000){
    return new Promise((resolve)=>{
      if(window.yRush && typeof yRush.getCart==='function') return resolve(true);
      const start = Date.now();
      const iv = setInterval(()=>{
        if(window.yRush && typeof yRush.getCart==='function'){ clearInterval(iv); return resolve(true); }
        if(Date.now()-start>timeout){ clearInterval(iv); return resolve(false); }
      },50);
    });
  }

  // ---------- cart helpers ----------
  function safeGetCartLines(){
    try{
      if(window.yRush && typeof yRush.getCart==='function'){
        const cartObj = yRush.getCart();
        if(cartObj) return yRush.cartLinesArray ? yRush.cartLinesArray(cartObj) : [];
      }
    }catch(e){}
    // fallback: try reading raw storage (most demos use 'yrush_cart')
    try{
      const raw = load('yrush_cart') || load('yRush_cart') || load('cart') || {};
      if(Array.isArray(raw)) return raw;
      // If stored as {id:qty}
      if(typeof raw === 'object' && raw !== null){
        if(window.yRush && yRush.cartLinesArray) return yRush.cartLinesArray(raw);
        // map to minimal line objects if possible
        return Object.keys(raw).map(id=>({id,qty:Number(raw[id])||0,price:0,name:id}));
      }
    }catch(e){}
    return [];
  }

  function cartTotal(lines){
    return Math.round(lines.reduce((s,l)=>s + (Number(l.price)||0) * (Number(l.qty)||0),0) * 100) / 100;
  }

  // mutable state
  let CART = [];
  let TOTAL = 0;

  const subtotalEl = document.getElementById('subtotal');
  const grandEl = document.getElementById('grand');
  const payBtn = document.getElementById('btnUpi');

  function updateUI(){
    TOTAL = cartTotal(CART);
    subtotalEl.textContent = money(TOTAL);
    grandEl.textContent = money(TOTAL);
    if(!TOTAL || TOTAL<=0){
      payBtn.classList.add('disabled');
      payBtn.classList.remove('primary');
      payBtn.title = 'Cart is empty';
    }else{
      payBtn.classList.remove('disabled');
      payBtn.classList.add('primary');
      payBtn.title = '';
    }
  }

  // initial load + yRush readiness
  async function initCart(){
    await new Promise(r=>{ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',r); else r(); });
    await ensureYRushReady(1500);
    CART = safeGetCartLines();
    updateUI();
  }
  initCart();

  // listen for cross-tab storage changes (cart updated elsewhere)
  window.addEventListener('storage', (e)=>{
    if(['yrush_cart','yRush_cart','cart'].includes(e.key) || e.key===null){
      CART = safeGetCartLines();
      updateUI();
    }
    if(e.key==='yRush_orders'){
      // optional: react to order updates
    }
  });

  // BroadcastChannel if app uses it
  try{
    if(typeof BroadcastChannel!=='undefined'){
      const ch = new BroadcastChannel('yRush_cart');
      ch.onmessage = msg=>{
        if(msg && msg.data && msg.data.type==='CART_UPDATED'){
          CART = safeGetCartLines();
          updateUI();
        }
      };
    }
  }catch(e){}

  // ---------- store orders ----------
  const pushOrder=(o)=>{
    const list=load('yRush_orders')||[];
    list.push(o);
    localStorage.setItem('yRush_orders',JSON.stringify(list));
    if(typeof BroadcastChannel!=='undefined'){
      const ch=new BroadcastChannel('yRush_orders');
      ch.postMessage({type:'ORDERS_UPDATED',timestamp:Date.now(),orderCount:list.length});
      ch.close();
    }
  };

  function lockPaymentUI(){
    const b=document.getElementById('btnUpi');
    if(!b)return;
    b.classList.add('disabled','ghost');
    b.classList.remove('primary');
    b.textContent='‚úî Payment received';
  }

  // ---------- go to QR ----------
  document.getElementById('btnUpi').addEventListener('click', async ()=>{
    // ensure latest cart/totals before checkout
    CART = safeGetCartLines();
    TOTAL = cartTotal(CART);
    if(!TOTAL||TOTAL<=0){alert('Your cart is empty!');return;}
    // validate minimal inputs (optional)
    const name = (document.getElementById('custName').value||'Customer').trim();
    const phone = (document.getElementById('custPhone').value||'').trim();
    const token=newToken();
    const order={
      token,
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString(),
      name,
      phone,
      email:(document.getElementById('custEmail').value||'').trim(),
      klass:(document.getElementById('custClass').value||'').trim(),
      notes:(document.getElementById('custNotes').value||'').trim(),
      pay:'upi-online',
      status:'Pending',
      total:TOTAL,
      lines:CART
    };
    save('pendingOrder',order);
    const url=new URL('Payment.html',location.href);
    url.searchParams.set('token',token);
    url.searchParams.set('amount',String(TOTAL));
    url.searchParams.set('return','checkOut.html');
    location.href=url.toString();
  });

  // ---------- finalize after payment ----------
  (function handleReturn(){
    if(localStorage.getItem('paymentDone')==='1'){
      const pending=load('pendingOrder');
      const box=document.getElementById('orderResult');
      if(pending){
        pending.status='Paid';
        pending.updatedAt=new Date().toISOString();
        pushOrder(pending);
        localStorage.removeItem('pendingOrder');
        localStorage.removeItem('paymentDone');
        try{ if(window.yRush && typeof yRush.clearCart==='function') yRush.clearCart(); }catch(e){}
        // also clear common storage keys
        ['yrush_cart','yRush_cart','cart'].forEach(k=>localStorage.removeItem(k));
        CART = [];
        updateUI();
        box.className='callout success';
        box.style.display='block';
        box.innerHTML=`‚úÖ <b>Payment successful!</b> Order placed.<br>Token: <b>${pending.token}</b>`;
        lockPaymentUI();
      }else{
        localStorage.removeItem('paymentDone');
      }
    }
  })();

  // ---------- reset ----------
  document.getElementById('btnReset').addEventListener('click',()=>{
    ['pendingOrder','paymentDone','yRush_orders','yrush_cart','yRush_cart','cart'].forEach(k=>localStorage.removeItem(k));
    try{ if(window.yRush && typeof yRush.clearCart==='function') yRush.clearCart(); }catch(e){}
    location.reload();
  });
</script>
</body>
</html>
